<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>Mini dosis de cari√±o</title>
  <link rel="stylesheet" href="./styles.css?v=4" />
</head>

<body>
  <!-- Cortinas -->
  <div class="curtainOverlay" id="curtainOverlay" aria-hidden="true">
    <div class="curtainWrap">
      <div class="valance"></div>
      <div class="curtain left"></div>
      <div class="curtain right"></div>
    </div>
  </div>

  <main class="phone" role="main">
    <header class="top">
      <h1>ü™Ñ Hola mi ni√±a üëßüèª</h1>
      <p class="sub">
        Si est√°s leyendo esto, seguro el d√≠a est√° m√°s pesado de lo que deber√≠a.
        Solo vengo a recordarte algo importante:
      </p>
    </header>

    <section class="card">
      <h2>Mini dosis de cari√±o</h2>
      <p>No est√°s sola en esta semana horrible, aqu√≠ sigo yo molest√°ndote a la distancia. ‚ú®</p>

      <button class="btnWide" id="magicBtn" type="button">‚ú® Abrir mi dosis</button>

      <div class="reveal" id="reveal" aria-live="polite">
        <p style="margin-top:12px; font-size:16px; line-height:1.35;">
          <span id="msgText">...</span>
        </p>

        <button class="btnWide" id="anotherBtn" type="button" style="margin-top:10px;">
          üîÑ Otra frase
        </button>
      </div>
    </section>

    <a class="btnWide" href="/index.html">‚Üê Volver</a>

    <footer class="footer">
      <small>Hecho con cari√±o.</small>
    </footer>
  </main>

  <script>
    // ====== Mensajes ======
    const MESSAGES = [
      // Frases principales
      "Hoy no tienes que ser fuerte, solo honesta contigo misma.",
      "Aunque el mundo est√© pesado, t√∫ sigues siendo de mis cosas favoritas.",
      "No importa c√≥mo te sientas hoy, sigues siendo suficiente.",
      "Si nadie te lo ha dicho hoy: lo est√°s haciendo mejor de lo que crees.",
      "Tu versi√≥n cansada tambi√©n merece amor.",

      // Mini recordatorios
      "Respira hondo 3 veces, yo respiro contigo desde ac√°.",
      "Tienes permiso total de estar cansada y seguir siendo incre√≠ble.",
      "Aunque el d√≠a est√© feo, t√∫ no eres el d√≠a: t√∫ sigues siendo t√∫.",
      "No hace falta que puedas con todo, a m√≠ me basta con que sigas aqu√≠.",
      "Si hoy solo logras descansar, ya hiciste mucho."
    ];

    // ====== Rotaci√≥n sin repetirse (por visita) ======
    const ORDER_KEY = "mdc_order_v1";
    const INDEX_KEY = "mdc_index_v1";

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getOrCreateOrder() {
      try {
        const raw = localStorage.getItem(ORDER_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed) && parsed.length === MESSAGES.length) return parsed;
      } catch (_) {}
      const newOrder = shuffle([...Array(MESSAGES.length).keys()]);
      localStorage.setItem(ORDER_KEY, JSON.stringify(newOrder));
      localStorage.setItem(INDEX_KEY, "0");
      return newOrder;
    }

    function getNextRotatingMessage() {
      const order = getOrCreateOrder();
      let idx = parseInt(localStorage.getItem(INDEX_KEY) || "0", 10);
      if (Number.isNaN(idx) || idx < 0) idx = 0;

      // Si ya se acabaron, reshuffle y reinicia
      if (idx >= order.length) {
        const newOrder = shuffle([...Array(MESSAGES.length).keys()]);
        localStorage.setItem(ORDER_KEY, JSON.stringify(newOrder));
        localStorage.setItem(INDEX_KEY, "1");
        return MESSAGES[newOrder[0]];
      }

      const msg = MESSAGES[order[idx]];
      localStorage.setItem(INDEX_KEY, String(idx + 1));
      return msg;
    }

    function getRandomDifferent(current) {
      if (MESSAGES.length <= 1) return current;
      let next = current;
      let guard = 0;
      while (next === current && guard < 20) {
        next = MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
        guard++;
      }
      return next;
    }

    // ====== Cortinas ======
    function runCurtains() {
      const overlay = document.getElementById("curtainOverlay");
      if (!overlay) return;

      // En m√≥vil a veces ‚Äúreduce motion‚Äù; igual mostramos, solo m√°s r√°pido
      const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      overlay.classList.remove("open", "done");
      overlay.offsetHeight;

      const openDelay = reduce ? 0 : 60;
      const doneDelay = reduce ? 250 : 1350;
      const removeDelay = reduce ? 450 : 1700;

      setTimeout(() => overlay.classList.add("open"), openDelay);
      setTimeout(() => overlay.classList.add("done"), doneDelay);
      setTimeout(() => overlay.remove(), removeDelay);
    }

    // ====== UI ======
    function wireUI() {
      const magicBtn = document.getElementById("magicBtn");
      const anotherBtn = document.getElementById("anotherBtn");
      const reveal = document.getElementById("reveal");
      const msgText = document.getElementById("msgText");

      let currentMessage = getNextRotatingMessage();
      if (msgText) msgText.textContent = currentMessage;

      magicBtn?.addEventListener("click", () => {
        reveal?.classList.add("show");
      });

      anotherBtn?.addEventListener("click", () => {
        const next = getRandomDifferent(currentMessage);
        currentMessage = next;
        if (msgText) msgText.textContent = next;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      runCurtains();
      wireUI();
    });

    // iOS a veces ‚Äúrecicla‚Äù p√°ginas (bfcache)
    window.addEventListener("pageshow", (e) => {
      if (e.persisted) runCurtains();
    });
  </script>
</body>
</html>
