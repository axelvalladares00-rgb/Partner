<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>Mini dosis de cari√±o</title>
  <link rel="stylesheet" href="./styles.css?v=8" />

  <style>
    /* Evita que el reveal recorte contenido (foto) */
    .reveal.show{
      max-height: 2400px !important;
    }

    /* Foto con transici√≥n */
    .photoStage{
      margin-top: 12px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);

      transform: translateY(6px) scale(.985);
      opacity: 0;
      transition: 220ms ease;
      will-change: transform, opacity;
    }
    .photoStage.show{
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .photoLoading{
      padding: 12px;
      text-align: center;
      color: rgba(255,255,255,.75);
      font-size: 13px;
      line-height: 1.35;
    }

    .photoStage img{
      display: block;
      width: 100%;
      height: auto;

      opacity: 0;
      transform: scale(1.02);
      transition: 260ms ease;
      will-change: opacity, transform;
    }

    .photoStage.imgLoaded img{
      opacity: 1;
      transform: scale(1);
    }

    .photoStage.imgLoaded .photoLoading{
      display: none;
    }

    .photoHint{
      color: rgba(255,255,255,.65);
      font-size: 12px;
      margin: 8px 0 0;
      text-align: center;
    }

    .photoFallback{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      padding: 12px;
      color: rgba(255,255,255,.78);
      font-size: 13px;
      line-height: 1.35;
      display: none;
    }
    .photoFallback.show{
      display: block;
    }
  </style>
</head>

<body>
  <!-- Cortinas -->
  <div class="curtainOverlay" id="curtainOverlay" aria-hidden="true">
    <div class="curtainWrap">
      <div class="valance"></div>
      <div class="curtain left"></div>
      <div class="curtain right"></div>
    </div>
  </div>

  <main class="phone" role="main">
    <header class="top">
      <h1>ü™Ñ Hola mi ni√±a üëßüèª</h1>
      <p class="sub">
        Si est√°s leyendo esto, seguro el d√≠a est√° m√°s pesado de lo que deber√≠a.
        Solo vengo a recordarte algo importante:
      </p>
    </header>

    <section class="card">
      <h2>Mini dosis de cari√±o</h2>
      <p>No est√°s sola en esta semana horrible, aqu√≠ sigo yo molest√°ndote a la distancia. ‚ú®</p>

      <button class="btnWide" id="magicBtn" type="button">‚ú® Abrir mi dosis</button>

      <div class="reveal" id="reveal" aria-live="polite">
        <p style="margin-top:12px; font-size:16px; line-height:1.35;">
          <span id="msgText">...</span>
        </p>

        <!-- Foto -->
        <div class="photoStage" id="photoStage">
          <div class="photoLoading" id="photoLoading">üì∏ Cargando nuestra foto‚Ä¶</div>
          <img
            id="photoImg"
            alt="Una foto bonita de nosotros"
            loading="eager"
            decoding="async"
          />
        </div>

        <div class="photoFallback" id="photoFallback">
          ü´∂ No pude cargar la foto.<br/><br/>
          Esto pasa si el archivo NO es realmente JPG/PNG por dentro (por ejemplo era HEIC/WEBP y solo se renombr√≥),
          o si el nombre/extensi√≥n no coincide.<br/><br/>
          Soluci√≥n r√°pida: vuelve a guardar la imagen como JPG desde tu compu/galer√≠a (exportar/guardar como),
          reemplaza el archivo y vuelve a hacer git push.
        </div>

        <p class="photoHint" id="photoHint">ü´∂ Un recordatorio visual de nosotros</p>

        <button class="btnWide" id="anotherBtn" type="button" style="margin-top:10px;">
          üîÑ Otra frase
        </button>
      </div>
    </section>

    <a class="btnWide" href="./index.html">‚Üê Volver</a>

    <footer class="footer">
      <small>Hecho con cari√±o.</small>
    </footer>
  </main>

  <script>
    const MESSAGES = [
      "Hoy no tienes que ser fuerte, solo honesta contigo misma.",
      "Aunque el mundo est√© pesado, t√∫ sigues siendo de mis cosas favoritas.",
      "No importa c√≥mo te sientas hoy, sigues siendo suficiente.",
      "Si nadie te lo ha dicho hoy: lo est√°s haciendo mejor de lo que crees.",
      "Tu versi√≥n cansada tambi√©n merece amor.",
      "Respira hondo 3 veces, yo respiro contigo desde ac√°.",
      "Tienes permiso total de estar cansada y seguir siendo incre√≠ble.",
      "Aunque el d√≠a est√© feo, t√∫ no eres el d√≠a: t√∫ sigues siendo t√∫.",
      "No hace falta que puedas con todo, a m√≠ me basta con que sigas aqu√≠.",
      "Si hoy solo logras descansar, ya hiciste mucho."
    ];

    const ORDER_KEY = "mdc_order_v1";
    const INDEX_KEY = "mdc_index_v1";

    function shuffle(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function getOrCreateOrder() {
      try {
        const raw = localStorage.getItem(ORDER_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        if (Array.isArray(parsed) && parsed.length === MESSAGES.length) return parsed;
      } catch (_) {}
      const newOrder = shuffle([...Array(MESSAGES.length).keys()]);
      localStorage.setItem(ORDER_KEY, JSON.stringify(newOrder));
      localStorage.setItem(INDEX_KEY, "0");
      return newOrder;
    }

    function getNextRotatingMessage() {
      const order = getOrCreateOrder();
      let idx = parseInt(localStorage.getItem(INDEX_KEY) || "0", 10);
      if (Number.isNaN(idx) || idx < 0) idx = 0;

      if (idx >= order.length) {
        const newOrder = shuffle([...Array(MESSAGES.length).keys()]);
        localStorage.setItem(ORDER_KEY, JSON.stringify(newOrder));
        localStorage.setItem(INDEX_KEY, "1");
        return MESSAGES[newOrder[0]];
      }

      const msg = MESSAGES[order[idx]];
      localStorage.setItem(INDEX_KEY, String(idx + 1));
      return msg;
    }

    function getRandomDifferent(current) {
      if (MESSAGES.length <= 1) return current;
      let next = current;
      let guard = 0;
      while (next === current && guard < 20) {
        next = MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
        guard++;
      }
      return next;
    }

    function runCurtains() {
      const overlay = document.getElementById("curtainOverlay");
      if (!overlay) return;

      const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      overlay.classList.remove("open", "done");
      overlay.offsetHeight;

      const openDelay = reduce ? 0 : 60;
      const doneDelay = reduce ? 250 : 1350;
      const removeDelay = reduce ? 450 : 1700;

      setTimeout(() => overlay.classList.add("open"), openDelay);
      setTimeout(() => overlay.classList.add("done"), doneDelay);
      setTimeout(() => overlay.remove(), removeDelay);
    }

    function loadPhotoCandidates() {
      const stage = document.getElementById("photoStage");
      const img = document.getElementById("photoImg");
      const fallback = document.getElementById("photoFallback");
      const reduce = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      if (!stage || !img) return;

      // Muestra el contenedor (con animaci√≥n r√°pida)
      stage.classList.add("show");

      const v = "8"; // cache bust
      const candidates = [
        `./assets/nosotros.jpg?v=${v}`,
        `./assets/Nosotros.jpg?v=${v}`,
        `./assets/nosotros.jpeg?v=${v}`,
        `./assets/Nosotros.jpeg?v=${v}`,
        `./assets/nosotros.png?v=${v}`,
        `./assets/Nosotros.png?v=${v}`,
      ];

      let i = 0;
      let loaded = false;

      const tryNext = () => {
        if (i >= candidates.length) {
          if (!loaded && fallback) fallback.classList.add("show");
          return;
        }

        const src = candidates[i++];
        img.onload = () => {
          loaded = true;
          stage.classList.add("imgLoaded");
          if (fallback) fallback.classList.remove("show");
          // si reduce motion, igual lo mostramos (sin delay extra)
          if (reduce) stage.classList.add("imgLoaded");
        };

        img.onerror = () => {
          tryNext();
        };

        img.src = src;
      };

      tryNext();
    }

    function wireUI() {
      const magicBtn = document.getElementById("magicBtn");
      const anotherBtn = document.getElementById("anotherBtn");
      const reveal = document.getElementById("reveal");
      const msgText = document.getElementById("msgText");

      let currentMessage = getNextRotatingMessage();
      if (msgText) msgText.textContent = currentMessage;

      magicBtn?.addEventListener("click", () => {
        reveal?.classList.add("show");
        loadPhotoCandidates();
      });

      anotherBtn?.addEventListener("click", () => {
        const next = getRandomDifferent(currentMessage);
        currentMessage = next;
        if (msgText) msgText.textContent = next;
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      runCurtains();
      wireUI();
    });

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) runCurtains();
    });
  </script>
</body>
</html>
