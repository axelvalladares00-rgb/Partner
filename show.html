<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>show1 sorpresa</title>
  <link rel="stylesheet" href="./styles.css?v=13" />

  <style>
    /* ====== Escenario centrado (16:9) ====== */
    .centerArea{
      display:flex;
      justify-content:center;
      align-items:center;
      width: 100%;
      min-height: 62vh;
    }

    .stage{
      width: min(92vw, 520px);
      aspect-ratio: 16 / 9;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      position: relative;
      isolation: isolate;
      margin: 0 auto; /* fuerza centrado */
    }

    .stage video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      background:#000;
      display:block;
    }

    /* Ocultar video cuando empieza el ‚Äúfinale‚Äù */
    .stage.hideVideo video{
      opacity: 0;
      transition: opacity 120ms ease;
    }

    /* Bot√≥n grande centrado */
    .playOverlay{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.55);
      z-index: 2;
      transition: opacity 200ms ease, transform 200ms ease;
      opacity: 1;
      transform: scale(1);
    }
    .playOverlay.off{
      opacity: 0;
      transform: scale(.985);
      pointer-events:none;
    }

    .playBig{
      width: min(86%, 360px);
      min-height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-size: 15px;
      font-weight: 650;
      letter-spacing: .2px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .playBig:active{ transform: scale(.99); }

    /* Pantalla blanca */
    .whiteout{
      position: fixed;
      inset: 0;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 2147483646;
      transition: opacity 120ms ease;
    }
    .whiteout.on{
      opacity: 1;
      pointer-events: auto;
    }

    /* Canvas fuegos (arriba de TODO) */
    .fxCanvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483647;
      pointer-events: none;
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .fxCanvas.on{ opacity: 1; }

    /* Bot√≥n volver (fallback por si tu CSS no lo tiene aqu√≠) */
    .btnWide{
      width:100%;
      display:grid;
      place-items:center;
      text-decoration:none;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 14px 10px;
      min-height: 48px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .btnWide:active{ transform: scale(.99); }

    /* ====== Texto final ====== */
    .afterLayer{
      position: fixed;
      inset: 0;
      z-index: 2147483645; /* debajo de fuegos, arriba del contenido */
      display: grid;
      place-items: center;
      padding: 18px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 240ms ease;
    }
    .afterLayer.on{
      opacity: 1;
      pointer-events: none;
    }

    .afterCard{
      width: min(92vw, 520px);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      backdrop-filter: blur(10px);
      padding: 16px 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
    }

    .bigTitle{
      margin: 0;
      font-size: 22px;
      line-height: 1.12;
      letter-spacing: .3px;
      text-align: center;
      color: rgba(255,255,255,.95);
      text-shadow: 0 0 18px rgba(120,180,255,.20);
    }

    .bigTitle span.char{
      display: inline-block;
      will-change: transform, opacity, filter;
    }

    .bigTitle.popIn span.char{
      animation: popIn 420ms ease forwards;
      animation-delay: var(--d, 0ms);
      opacity: 0;
      transform: translateY(8px) scale(.98);
      filter: blur(2px);
    }

    @keyframes popIn{
      to{
        opacity: 1;
        transform: translateY(0) scale(1);
        filter: blur(0);
      }
    }

    /* ‚ÄúDesintegraci√≥n‚Äù tipo polvo */
    .bigTitle.dustOut span.char{
      animation: dustOut 950ms ease forwards;
      animation-delay: var(--d, 0ms);
    }
    @keyframes dustOut{
      to{
        opacity: 0;
        transform: translate3d(var(--tx, 14px), var(--ty, -10px), 0) rotate(var(--rot, 6deg));
        filter: blur(6px);
      }
    }

    .longMsg{
      display: none;
      margin-top: 12px;
      color: rgba(255,255,255,.90);
      font-size: 14px;
      line-height: 1.45;
      white-space: pre-wrap;
    }
    .longMsg.on{
      display: block;
      animation: fadeInUp 520ms ease both;
    }

    @keyframes fadeInUp{
      from{ opacity: 0; transform: translateY(10px); filter: blur(2px); }
      to{ opacity: 1; transform: translateY(0); filter: blur(0); }
    }
  </style>
</head>

<body>
  <div class="whiteout" id="whiteout" aria-hidden="true"></div>
  <canvas class="fxCanvas" id="fxCanvas" aria-hidden="true"></canvas>

  <!-- Texto final -->
  <div class="afterLayer" id="afterLayer" aria-hidden="true">
    <div class="afterCard">
      <h2 class="bigTitle" id="bigTitle"></h2>
      <div class="longMsg" id="longMsg"></div>
    </div>
  </div>

  <main class="phone" role="main">
    <header class="top">
      <h1>üé¨ show1 sorpresa</h1>
    </header>

    <section class="card">
      <div class="centerArea">
        <div class="stage" id="stage">
          <video
            id="scene"
            src="./assets/show1.mp4"
            playsinline
            webkit-playsinline
            preload="auto"
          ></video>

          <div class="playOverlay" id="playOverlay">
            <button class="playBig" id="playBig" type="button">‚ñ∂Ô∏è Dale play por favor</button>
          </div>
        </div>
      </div>
    </section>

    <a class="btnWide" href="./index.html">‚Üê Volver</a>

    <footer class="footer">
      <small>Hecho con cari√±o.</small>
    </footer>
  </main>

  <script>
    // ====== CONFIG ======
    const START_AT      = 0;       // ya lo editaste: inicia desde 0
    const WHITEOUT_MS   = 2000;    // blanco 2s
    const FIREWORKS_MS  = 4200;    // m√°s show
    const END_GUARD     = 0.18;    // fallback por tiempo
    const BURST_EVERY   = 260;     // m√°s frecuente
    const BURST_COUNT   = 95;      // m√°s part√≠culas (extravagante)

    // ====== Textos ======
    const TITLE_TEXT =
      "FELIZ A√ëO NUEVO MI NI√ëA üíôCON UNA BONITA SONRISA y UN BONITO GL√öTEO JAJA ‚ú®";

    const LONG_TEXT =
`Feliz A√±o Nuevo, mi ni√±a üéÜüí´
Otro a√±o que cerramos lejos, pero al mismo tiempo m√°s cerca que nunca. A veces la distancia pesa, pero cuando pienso en ti, en tu risa, en nuestras llamadas y en todo lo que hemos pasado, siento que vale totalmente la pena.
Quiero que este nuevo a√±o tengas m√°s momentos de paz, m√°s risas sinceras y menos d√≠as pesados. Y tambi√©n quiero m√°s ‚Äúnosotros‚Äù: m√°s llamadas tontas, m√°s mensajes bonitos‚Ä¶ y s√≠, m√°s recuerdos juntos como los que nos esperan en marzo.
No puedo prometerte un a√±o perfecto, pero s√≠ puedo prometerte que voy a seguir intentando cuidar de ti, apoyarte y hacerte sentir importante, porque lo eres.
Gracias por ser mi persona en este mundo tan raro, mi ni√±a. Te quiero m√°s de lo que estas letras pueden decir. üíô`;

    const scene = document.getElementById("scene");
    const stage = document.getElementById("stage");
    const playOverlay = document.getElementById("playOverlay");
    const playBig = document.getElementById("playBig");
    const whiteout = document.getElementById("whiteout");
    const canvas = document.getElementById("fxCanvas");

    const afterLayer = document.getElementById("afterLayer");
    const bigTitle = document.getElementById("bigTitle");
    const longMsg = document.getElementById("longMsg");

    let metadataReady = false;
    let finaleStarted = false;
    let endWatchTimer = null;

    // ====== Canvas setup ======
    const ctx = canvas.getContext("2d");
    let dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));

    function resizeCanvas(){
      dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ====== Fireworks (extravagantes) ======
    const particles = [];
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function burst(x, y){
      const count = BURST_COUNT;
      const hueBase = rand(0, 360);

      for(let i=0;i<count;i++){
        const a = rand(0, Math.PI * 2);
        const sp = rand(2.6, 8.4);
        const hue = (hueBase + rand(-45, 45) + 360) % 360;

        particles.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          life: rand(48, 86),
          r: rand(1.1, 2.8),
          c: `hsl(${Math.floor(hue)} 95% 62%)`,
          tw: rand(0.25, 0.75) // brillo intermitente
        });
      }

      // mini ‚Äúsparkles‚Äù
      for(let k=0;k<14;k++){
        particles.push({
          x: x + rand(-20, 20),
          y: y + rand(-20, 20),
          vx: rand(-1.2, 1.2),
          vy: rand(-1.8, 0.2),
          life: rand(22, 36),
          r: rand(0.8, 1.6),
          c: `rgba(255,255,255,.85)`,
          tw: rand(0.2, 0.9)
        });
      }
    }

    let fxStart = 0;
    let lastBurst = 0;

    function fxLoop(ts){
      if(!fxStart) fxStart = ts;
      const t = ts - fxStart;

      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

      // bursts m√°s frecuentes + dobles
      if(ts - lastBurst > BURST_EVERY){
        lastBurst = ts;
        burst(rand(70, window.innerWidth-70), rand(110, window.innerHeight*0.55));
        if(Math.random() < 0.45){
          burst(rand(70, window.innerWidth-70), rand(110, window.innerHeight*0.55));
        }
      }

      // part√≠culas + ‚Äútrail‚Äù suave
      for(let i=particles.length-1; i>=0; i--){
        const p = particles[i];

        // gravedad + drift
        p.vy += 0.055;
        p.vx *= 0.99;
        p.vy *= 0.99;

        const px = p.x, py = p.y;

        p.x += p.vx;
        p.y += p.vy;
        p.life -= 1;

        const alpha = Math.max(0, Math.min(1, p.life/90));
        const twinkle = 0.6 + 0.4 * Math.sin((90 - p.life) * p.tw);

        // trail
        ctx.globalAlpha = alpha * 0.25;
        ctx.strokeStyle = p.c;
        ctx.lineWidth = Math.max(1, p.r);
        ctx.beginPath();
        ctx.moveTo(px, py);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();

        // core
        ctx.globalAlpha = alpha * twinkle;
        ctx.fillStyle = p.c;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();

        if(p.life <= 0) particles.splice(i,1);
      }
      ctx.globalAlpha = 1;

      if(t < FIREWORKS_MS){
        requestAnimationFrame(fxLoop);
      }else{
        stopFireworks();
        showTextsSequence();
      }
    }

    function startFireworks(){
      canvas.classList.add("on");
      fxStart = 0;
      lastBurst = 0;
      particles.length = 0;
      requestAnimationFrame(fxLoop);
    }

    function stopFireworks(){
      canvas.classList.remove("on");
      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      particles.length = 0;
    }

    // ====== Text sequence ======
    function buildTitleSpans(text){
      bigTitle.innerHTML = "";
      const lines = text.split("\n");

      lines.forEach((line, lineIdx) => {
        const lineWrap = document.createElement("div");
        lineWrap.style.display = "block";

        const chars = Array.from(line);
        chars.forEach((ch, i) => {
          const s = document.createElement("span");
          s.className = "char";
          s.textContent = ch === " " ? "\u00A0" : ch;

          // delays suaves
          const delay = (lineIdx * 140) + (i * 18);
          s.style.setProperty("--d", `${delay}ms`);

          // random para ‚Äúdust‚Äù
          s.style.setProperty("--tx", `${Math.floor(rand(-22, 26))}px`);
          s.style.setProperty("--ty", `${Math.floor(rand(-18, 14))}px`);
          s.style.setProperty("--rot", `${Math.floor(rand(-10, 12))}deg`);

          lineWrap.appendChild(s);
        });

        bigTitle.appendChild(lineWrap);
      });
    }

    async function showTextsSequence(){
      afterLayer.classList.add("on");
      afterLayer.setAttribute("aria-hidden", "false");

      // t√≠tulo
      buildTitleSpans(TITLE_TEXT);
      bigTitle.classList.remove("dustOut");
      bigTitle.classList.add("popIn");

      // espera un poquito para que se lea
      await new Promise(r => setTimeout(r, 2200));

      // ‚Äúsnap/dust‚Äù
      bigTitle.classList.remove("popIn");
      bigTitle.classList.add("dustOut");

      // espera la animaci√≥n de desintegraci√≥n
      await new Promise(r => setTimeout(r, 1050));

      // mensaje largo
      bigTitle.style.display = "none";
      longMsg.textContent = LONG_TEXT;
      longMsg.classList.add("on");
    }

    // ====== Helpers ======
    async function ensureMetadata(){
      if(metadataReady) return;
      await new Promise((resolve) => {
        scene.addEventListener("loadedmetadata", resolve, { once: true });
      });
      metadataReady = true;
    }

    async function seekReliable(){
      await ensureMetadata();
      await new Promise((resolve) => {
        let done = false;
        const finish = () => { if(done) return; done = true; resolve(); };

        scene.addEventListener("seeked", finish, { once: true });

        try{
          const dur = scene.duration || (START_AT + 1);
          scene.currentTime = Math.min(START_AT, Math.max(0, dur - 0.2));
        }catch(_){
          finish();
          return;
        }

        setTimeout(finish, 280);
      });
    }

    function resetUI(){
      stopFireworks();
      whiteout.classList.remove("on");
      finaleStarted = false;

      if(endWatchTimer){
        clearInterval(endWatchTimer);
        endWatchTimer = null;
      }

      stage.classList.remove("hideVideo");

      afterLayer.classList.remove("on");
      afterLayer.setAttribute("aria-hidden", "true");
      bigTitle.style.display = "";
      bigTitle.className = "bigTitle";
      bigTitle.innerHTML = "";
      longMsg.className = "longMsg";
      longMsg.textContent = "";
    }

    // ====== Final: blanco 2s -> fuegos -> textos ======
    async function startFinale(){
      if(finaleStarted) return;
      finaleStarted = true;

      if(endWatchTimer){
        clearInterval(endWatchTimer);
        endWatchTimer = null;
      }

      // video ya no debe verse en el blanco ni despu√©s
      stage.classList.add("hideVideo");

      try{ scene.pause(); }catch(_){}

      whiteout.classList.add("on");

      // fuerza repintado en iPhone
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

      await new Promise(r => setTimeout(r, WHITEOUT_MS));

      whiteout.classList.remove("on");

      // fuegos (sin video)
      startFireworks();
    }

    function startEndWatcher(){
      if(endWatchTimer) clearInterval(endWatchTimer);

      endWatchTimer = setInterval(() => {
        if(finaleStarted) return;

        if(scene.ended) {
          startFinale();
          return;
        }

        const dur = scene.duration;
        if(Number.isFinite(dur) && dur > 0){
          if(scene.currentTime >= dur - END_GUARD){
            startFinale();
          }
        }
      }, 140);
    }

    async function startShow(){
      resetUI();

      await seekReliable();

      try{
        await scene.play();
        playOverlay.classList.add("off");
        startEndWatcher();
      }catch(e){
        // Si no reproduce, dejamos el overlay
        console.log("No se pudo reproducir:", e);
      }
    }

    // ====== Events ======
    scene.addEventListener("ended", () => startFinale());

    scene.addEventListener("webkitendfullscreen", () => {
      const dur = scene.duration;
      if(!finaleStarted && Number.isFinite(dur) && scene.currentTime >= dur - 0.25){
        startFinale();
      }
    });

    scene.addEventListener("error", () => {
      console.log("No se pudo cargar el video: ./assets/show1.mp4");
    });

    playBig.addEventListener("click", () => startShow());

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) resetUI();
    });
  </script>
</body>
</html>
