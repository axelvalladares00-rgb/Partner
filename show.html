<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>show1 sorpresa</title>
  <link rel="stylesheet" href="./styles.css?v=11" />

  <style>
    .videoFrame{
      margin-top: 12px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      position: relative;
    }
    .videoFrame video{
      display:block;
      width: 100%;
      height: auto;
      background: #000;
      object-fit: contain;
    }

    /* M√°scara inicial para que no se vea ‚Äúflash‚Äù del segundo 0 */
    .startMask{
      position:absolute;
      inset:0;
      background:#000;
      opacity: 1;
      transition: opacity 220ms ease;
      pointer-events:none;
      display:grid;
      place-items:center;
      padding: 16px;
      text-align:center;
      color: rgba(255,255,255,.85);
      font-size: 13px;
      line-height: 1.35;
    }
    .startMask.off{ opacity: 0; }

    /* Pantalla blanca */
    .whiteout{
      position: fixed;
      inset: 0;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 9998;
      transition: opacity 120ms ease;
    }
    .whiteout.on{ opacity: 1; pointer-events: auto; }

    /* Canvas fuegos */
    .fxCanvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .fxCanvas.on{ opacity: 1; }

    .msgBox{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 12px;
      display:none;
    }
    .msgBox.show{ display:block; }

    .btnWide{
      width:100%;
      display:grid;
      place-items:center;
      text-decoration:none;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 14px 10px;
      min-height: 48px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .btnWide:active{ transform: scale(.99); }
  </style>
</head>

<body>
  <div class="whiteout" id="whiteout" aria-hidden="true"></div>
  <canvas class="fxCanvas" id="fxCanvas" aria-hidden="true"></canvas>

  <main class="phone" role="main">
    <header class="top">
      <h1>üé¨ show1 sorpresa</h1>
      <p class="sub">Entra y se reproduce solo. Al terminar: flash blanco + celebraci√≥n üéÜ</p>
    </header>

    <section class="card">
      <h2>Escena</h2>
      <p style="margin:0 0 10px;">Aseg√∫rate que exista: <b>assets/show1.mp4</b></p>

      <div class="videoFrame">
        <video
          id="scene"
          src="./assets/show1.mp4"
          playsinline
          webkit-playsinline
          preload="auto"
        ></video>

        <!-- Solo se ve si el autoplay falla (√∫ltimo recurso) -->
        <div class="startMask" id="startMask" aria-hidden="true"></div>
      </div>

      <div class="msgBox" id="msgBox" aria-live="polite">
        <p style="margin:0; font-size:16px; line-height:1.35;">
          ‚ú® Aqu√≠ va tu mensaje final (lo cambiamos cuando me digas cu√°l).
        </p>
      </div>
    </section>

    <a class="btnWide" href="./index.html">‚Üê Volver</a>

    <footer class="footer">
      <small>Hecho con cari√±o.</small>
    </footer>
  </main>

  <script>
    // ====== CONFIG ======
    const START_AT     = 4;     // arranca desde el segundo 4
    const WHITEOUT_MS  = 2000;  // blanco 2s
    const FIREWORKS_MS = 3200;  // fuegos ~3.2s

    const scene = document.getElementById("scene");
    const whiteout = document.getElementById("whiteout");
    const canvas = document.getElementById("fxCanvas");
    const msgBox = document.getElementById("msgBox");
    const startMask = document.getElementById("startMask");

    let triggered = false;
    let metadataReady = false;

    // ====== Canvas setup ======
    const ctx = canvas.getContext("2d");
    let dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));

    function resizeCanvas(){
      dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ====== Fireworks ======
    const particles = [];
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function burst(x, y){
      const count = 46;
      for(let i=0;i<count;i++){
        const a = rand(0, Math.PI * 2);
        const sp = rand(2.2, 6.2);
        particles.push({
          x, y,
          vx: Math.cos(a)*sp,
          vy: Math.sin(a)*sp,
          life: rand(38, 62),
          r: rand(1.2, 2.4),
          c: `hsl(${Math.floor(rand(0, 360))} 90% 60%)`
        });
      }
    }

    let fxStart = 0;
    let lastBurst = 0;

    function fxLoop(ts){
      if(!fxStart) fxStart = ts;
      const t = ts - fxStart;

      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

      if(ts - lastBurst > 420){
        lastBurst = ts;
        burst(rand(60, window.innerWidth-60), rand(90, window.innerHeight*0.55));
      }

      for(let i=particles.length-1; i>=0; i--){
        const p = particles[i];
        p.vy += 0.06;
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 1;

        const alpha = Math.max(0, Math.min(1, p.life/60));
        ctx.globalAlpha = alpha;
        ctx.fillStyle = p.c;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();

        if(p.life <= 0) particles.splice(i,1);
      }
      ctx.globalAlpha = 1;

      if(t < FIREWORKS_MS){
        requestAnimationFrame(fxLoop);
      }else{
        stopFireworks();
        showFinalMessage();
      }
    }

    function startFireworks(){
      canvas.classList.add("on");
      fxStart = 0;
      lastBurst = 0;
      particles.length = 0;
      requestAnimationFrame(fxLoop);
    }

    function stopFireworks(){
      canvas.classList.remove("on");
      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      particles.length = 0;
    }

    function showFinalMessage(){
      msgBox.classList.add("show");
    }

    // ====== Helpers ======
    function resetUI(){
      msgBox.classList.remove("show");
      stopFireworks();
      whiteout.classList.remove("on");
      triggered = false;
      if(startMask){
        startMask.classList.remove("off");
        startMask.textContent = "";
      }
    }

    function seekToStart(){
      try{ scene.currentTime = START_AT; }catch(_){}
    }

    async function ensureMetadata(){
      if(metadataReady) return;
      await new Promise((resolve) => {
        const onMeta = () => { resolve(); };
        scene.addEventListener("loadedmetadata", onMeta, { once: true });
      });
      metadataReady = true;
    }

    // Espera a que el seek ‚Äúpegue‚Äù (mejor en m√≥vil)
    async function seekReliable(){
      return await new Promise((resolve) => {
        let done = false;
        const finish = () => { if(done) return; done = true; resolve(); };

        const onSeeked = () => {
          scene.removeEventListener("seeked", onSeeked);
          finish();
        };

        scene.addEventListener("seeked", onSeeked, { once: true });

        try{
          scene.currentTime = START_AT;
        }catch(_){
          scene.removeEventListener("seeked", onSeeked);
          finish();
          return;
        }

        // fallback por si el navegador no dispara seeked
        setTimeout(() => {
          scene.removeEventListener("seeked", onSeeked);
          finish();
        }, 220);
      });
    }

    async function whiteoutSequence(){
      if(triggered) return;
      triggered = true;

      try{ scene.pause(); } catch(_){}

      whiteout.classList.add("on");
      await new Promise(r => setTimeout(r, WHITEOUT_MS));
      whiteout.classList.remove("on");

      startFireworks();
    }

    // ====== START (sin botones) ======
    async function startShow(){
      resetUI();

      await ensureMetadata();

      // Para que sea fluido y permitido en m√≥vil:
      // autoplay casi siempre requiere muted.
      scene.muted = true;

      // Seek al segundo 4 ANTES de reproducir
      await seekReliable();

      // Intento play
      try{
        await scene.play();

        // Cuando ya est√° reproduciendo, quitamos m√°scara
        scene.addEventListener("playing", () => {
          if(startMask) startMask.classList.add("off");
        }, { once: true });

        // Si tarda el "playing", quitamos m√°scara igual (r√°pido)
        setTimeout(() => startMask && startMask.classList.add("off"), 350);

      }catch(e){
        // √öltimo recurso: algunos m√≥viles MUY estrictos.
        // No ponemos botones, solo un texto y escuchamos un toque en cualquier parte.
        if(startMask){
          startMask.textContent = "Si tu tel√©fono bloque√≥ el autoplay, toca la pantalla una vez para iniciar ‚ú®";
        }

        const resume = async () => {
          document.removeEventListener("pointerdown", resume);
          try{
            await scene.play();
            if(startMask) startMask.classList.add("off");
          }catch(_){}
        };

        document.addEventListener("pointerdown", resume, { once: true });
      }
    }

    // ====== EVENTS ======
    scene?.addEventListener("ended", () => {
      whiteoutSequence();
    });

    scene?.addEventListener("error", () => {
      if(startMask){
        startMask.textContent = "No se pudo cargar el video. Revisa: assets/show1.mp4";
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      startShow();
    });

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) startShow();
    });
  </script>
</body>
</html>