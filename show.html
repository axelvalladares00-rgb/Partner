<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f17" />
  <title>show1 sorpresa</title>
  <link rel="stylesheet" href="./styles.css?v=15" />

  <style>
    .centerArea{
      display: grid;
      place-items: center;
      min-height: calc(100svh - 210px);
      padding: 10px 0;
    }

    .stage{
      width: min(92vw, 520px);
      aspect-ratio: 16 / 9;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      position: relative;
      isolation: isolate;
      margin-inline: auto;

      /* üëá Nudge a la izquierda para iPhone */
      transform: translateX(-12px) translateY(0) scale(1);

      transition: opacity 260ms ease, transform 260ms ease;
      opacity: 1;
      pointer-events: auto;
    }

    .stage.hiddenNow{
      opacity: 0;
      pointer-events: none;
      transform: translateX(-12px) translateY(8px) scale(.99);
    }

    .stage video{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      background:#000;
      display:block;

      /* üëá Empuja el encuadre un poco a la IZQ */
      object-position: 44% 50%;
    }

    .playOverlay{
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.55);
      z-index: 2;
      transition: opacity 200ms ease, transform 200ms ease;
      opacity: 1;
      transform: scale(1);
    }
    .playOverlay.off{
      opacity: 0;
      transform: scale(.985);
      pointer-events:none;
    }

    .playBig{
      width: min(86%, 320px);
      min-height: 52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      font-size: 15px;
      font-weight: 650;
      letter-spacing: .2px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      padding: 10px 14px;
    }
    .playBig:active{ transform: scale(.99); }

    .whiteout{
      position: fixed;
      inset: 0;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 2147483646;
      transition: opacity 120ms ease;
    }
    .whiteout.on{
      opacity: 1;
      pointer-events: auto;
    }

    .fxCanvas{
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 2147483647;
      pointer-events: none;
      opacity: 0;
      transition: opacity 180ms ease;
    }
    .fxCanvas.on{ opacity: 1; }

    .btnWide{
      width:100%;
      display:grid;
      place-items:center;
      text-decoration:none;
      color: rgba(255,255,255,.92);
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      padding: 14px 10px;
      min-height: 48px;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .btnWide:active{ transform: scale(.99); }
  </style>
</head>

<body>
  <div class="whiteout" id="whiteout" aria-hidden="true"></div>
  <canvas class="fxCanvas" id="fxCanvas" aria-hidden="true"></canvas>

  <main class="phone" role="main">
    <header class="top">
      <h1>üé¨ show1 sorpresa</h1>
    </header>

    <section class="card">
      <div class="centerArea">
        <div class="stage" id="stage">
          <video
            id="scene"
            src="./assets/show1.mp4"
            playsinline
            webkit-playsinline
            preload="auto"
          ></video>

          <div class="playOverlay" id="playOverlay">
            <button class="playBig" id="playBig" type="button">‚ñ∂Ô∏è Dale play por favor</button>
          </div>
        </div>
      </div>
    </section>

    <a class="btnWide" href="./index.html">‚Üê Volver</a>

    <footer class="footer">
      <small>Hecho con cari√±o.</small>
    </footer>
  </main>

  <script>
    const WHITEOUT_MS  = 2000;   // blanco 2s
    const FIREWORKS_MS = 4200;   // fuegos m√°s largos
    const END_GUARD    = 0.18;   // margen por si "ended" falla

    const stage = document.getElementById("stage");
    const scene = document.getElementById("scene");
    const playOverlay = document.getElementById("playOverlay");
    const playBig = document.getElementById("playBig");
    const whiteout = document.getElementById("whiteout");
    const canvas = document.getElementById("fxCanvas");

    let finaleStarted = false;
    let endWatchTimer = null;

    // ===== Canvas setup =====
    const ctx = canvas.getContext("2d");
    let dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));

    function resizeCanvas(){
      dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ===== Fireworks (m√°s extravagantes) =====
    const particles = [];
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function burst(x, y, power = 1){
      const base = 80;                    // m√°s part√≠culas
      const count = Math.floor(base * power);
      for(let i=0;i<count;i++){
        const a = rand(0, Math.PI * 2);
        const sp = rand(2.0, 7.8) * power;
        particles.push({
          x, y,
          vx: Math.cos(a) * sp,
          vy: Math.sin(a) * sp,
          life: rand(40, 85),
          r: rand(1.2, 3.2) * (0.9 + power*0.15),
          hue: Math.floor(rand(0, 360)),
          trail: []
        });
      }

      // ‚Äúanillo‚Äù extra para que se vea m√°s wow
      const ringCount = Math.floor(26 * power);
      for(let i=0;i<ringCount;i++){
        const a = (i / ringCount) * Math.PI * 2;
        const sp = rand(3.2, 5.2) * power;
        particles.push({
          x, y,
          vx: Math.cos(a) * sp,
          vy: Math.sin(a) * sp,
          life: rand(48, 82),
          r: rand(1.2, 2.4),
          hue: (Math.floor(rand(0, 360)) + 40) % 360,
          trail: []
        });
      }
    }

    let fxStart = 0;
    let lastBurst = 0;

    function fxLoop(ts){
      if(!fxStart) fxStart = ts;
      const t = ts - fxStart;

      // fondo transparente
      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

      // brillo tipo ‚Äúextravagante‚Äù
      ctx.globalCompositeOperation = "lighter";

      // m√°s bursts y algunos mega
      const interval = 260;
      if(ts - lastBurst > interval){
        lastBurst = ts;

        const x = rand(40, window.innerWidth - 40);
        const y = rand(80, window.innerHeight * 0.52);

        const mega = Math.random() < 0.22;
        burst(x, y, mega ? rand(1.25, 1.6) : rand(0.95, 1.15));

        // burst secundario cercano (doble explosi√≥n)
        if(Math.random() < 0.35){
          burst(x + rand(-60, 60), y + rand(-35, 35), rand(0.75, 1.0));
        }
      }

      for(let i=particles.length-1; i>=0; i--){
        const p = particles[i];

        // trail (cola)
        p.trail.push({x: p.x, y: p.y});
        if(p.trail.length > 6) p.trail.shift();

        // f√≠sica
        p.vy += 0.055;
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 1;

        const alpha = Math.max(0, Math.min(1, p.life/85));

        // dibuja trail
        ctx.globalAlpha = alpha * 0.55;
        ctx.strokeStyle = `hsla(${p.hue} 95% 65% / 1)`;
        ctx.lineWidth = Math.max(1, p.r * 0.8);
        ctx.beginPath();
        for(let k=0; k<p.trail.length; k++){
          const pt = p.trail[k];
          if(k === 0) ctx.moveTo(pt.x, pt.y);
          else ctx.lineTo(pt.x, pt.y);
        }
        ctx.stroke();

        // spark principal
        ctx.globalAlpha = alpha;
        ctx.fillStyle = `hsla(${p.hue} 95% 65% / 1)`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
        ctx.fill();

        // glow extra
        ctx.globalAlpha = alpha * 0.35;
        ctx.fillStyle = `hsla(${p.hue} 95% 70% / 1)`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r * 2.1, 0, Math.PI*2);
        ctx.fill();

        if(p.life <= 0) particles.splice(i,1);
      }

      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = "source-over";

      if(t < FIREWORKS_MS){
        requestAnimationFrame(fxLoop);
      }else{
        stopFireworks();
        // al terminar: queda solo el fondo (no stage)
      }
    }

    function startFireworks(){
      canvas.classList.add("on");
      fxStart = 0;
      lastBurst = 0;
      particles.length = 0;
      requestAnimationFrame(fxLoop);
    }

    function stopFireworks(){
      canvas.classList.remove("on");
      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);
      particles.length = 0;
    }

    function resetUI(){
      stopFireworks();
      whiteout.classList.remove("on");
      finaleStarted = false;

      if(endWatchTimer){
        clearInterval(endWatchTimer);
        endWatchTimer = null;
      }

      // restaura stage por si recargas
      if(stage){
        stage.style.display = "";
        stage.classList.remove("hiddenNow");
      }

      playOverlay.classList.remove("off");
    }

    async function startFinale(){
      if(finaleStarted) return;
      finaleStarted = true;

      if(endWatchTimer){
        clearInterval(endWatchTimer);
        endWatchTimer = null;
      }

      // corta video y OCULTA el stage para que NO se vea debajo del blanco
      try{ scene.pause(); }catch(_){}
      if(stage) stage.classList.add("hiddenNow");

      // blanco 2s
      whiteout.classList.add("on");
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      await new Promise(r => setTimeout(r, WHITEOUT_MS));
      whiteout.classList.remove("on");

      // fuegos en el fondo
      startFireworks();

      // ya no mostramos el stage nunca m√°s en esta visita
      setTimeout(() => {
        if(stage) stage.style.display = "none";
      }, 260);
    }

    function startEndWatcher(){
      if(endWatchTimer) clearInterval(endWatchTimer);

      endWatchTimer = setInterval(() => {
        if(finaleStarted) return;

        if(scene.ended){
          startFinale();
          return;
        }

        const dur = scene.duration;
        if(Number.isFinite(dur) && dur > 0){
          if(scene.currentTime >= dur - END_GUARD){
            startFinale();
          }
        }
      }, 120);
    }

    function startShowFromClick(){
      resetUI();

      // desde 0
      try{ scene.currentTime = 0; }catch(_){}

      // iPhone: permite play tras click; muted ayuda a que sea m√°s estable
      scene.muted = true;

      const onPlaying = () => {
        playOverlay.classList.add("off");
        startEndWatcher();
      };
      scene.addEventListener("playing", onPlaying, { once: true });

      const p = scene.play();
      if(p && typeof p.catch === "function"){
        p.catch(() => {
          scene.removeEventListener("playing", onPlaying);
        });
      }
    }

    scene.addEventListener("ended", () => startFinale());

    // Por si iOS hace cosas raras al volver de fullscreen
    scene.addEventListener("webkitendfullscreen", () => {
      const dur = scene.duration;
      if(!finaleStarted && Number.isFinite(dur) && scene.currentTime >= dur - 0.25){
        startFinale();
      }
    });

    playBig.addEventListener("click", startShowFromClick);

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) resetUI();
    });
  </script>
</body>
</html>
